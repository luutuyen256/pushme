<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PushMe - Debug Test</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    .log {
      background: #252526;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      border-left: 3px solid #007acc;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .log.error {
      border-left-color: #f48771;
    }
    .log.success {
      border-left-color: #89d185;
    }
    button {
      background: #0e639c;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #1177bb;
    }
    .info {
      background: #264f78;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
    }
    h1 {
      color: #4ec9b0;
    }
    h2 {
      color: #569cd6;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <h1>üîß PushMe Debug Test</h1>
  
  <div class="info">
    <h2>Browser Info</h2>
    <div id="browser-info"></div>
  </div>

  <div>
    <button onclick="testServiceWorker()">1. Test Service Worker</button>
    <button onclick="testVapidKey()">2. Test VAPID Key</button>
    <button onclick="testNotificationPermission()">3. Request Permission</button>
    <button onclick="testSubscribe()">4. Subscribe to Push</button>
    <button onclick="testSendNotification()">5. Send Test Notification</button>
    <button onclick="clearLogs()">Clear Logs</button>
  </div>

  <h2>Console Logs:</h2>
  <div id="logs"></div>

  <script>
    const API_BASE_URL = 'https://3lxt16dul9.execute-api.ap-southeast-1.amazonaws.com';
    let swRegistration = null;
    let vapidPublicKey = null;

    function log(message, type = 'info') {
      const logDiv = document.createElement('div');
      logDiv.className = `log ${type}`;
      logDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      document.getElementById('logs').appendChild(logDiv);
      console.log(message);
    }

    function clearLogs() {
      document.getElementById('logs').innerHTML = '';
    }

    // Show browser info
    function showBrowserInfo() {
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isStandalone = window.navigator.standalone === true;
      const matchesStandalone = window.matchMedia('(display-mode: standalone)').matches;
      
      const info = `
        User Agent: ${navigator.userAgent}
        
        Is iOS: ${isIOS}
        iOS Standalone (navigator.standalone): ${isStandalone}
        Display Mode Standalone: ${matchesStandalone}
        
        Service Worker Support: ${'serviceWorker' in navigator}
        Push Manager Support: ${'PushManager' in window}
        Notification Support: ${'Notification' in window}
        Notification Permission: ${Notification.permission}
      `;
      
      document.getElementById('browser-info').textContent = info;
    }

    // Test Service Worker
    async function testServiceWorker() {
      try {
        log('üìù Registering Service Worker...');
        const registration = await navigator.serviceWorker.register('/sw.js');
        log('‚úÖ Service Worker registered: ' + registration.scope, 'success');
        
        await navigator.serviceWorker.ready;
        swRegistration = registration;
        log('‚úÖ Service Worker ready', 'success');
      } catch (error) {
        log('‚ùå Service Worker failed: ' + error.message, 'error');
      }
    }

    // Test VAPID Key
    async function testVapidKey() {
      try {
        log('üìù Fetching VAPID key from server...');
        const response = await fetch(`${API_BASE_URL}/vapid-public-key`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        vapidPublicKey = data.publicKey;
        log('‚úÖ VAPID key received: ' + vapidPublicKey.substring(0, 50) + '...', 'success');
      } catch (error) {
        log('‚ùå VAPID key failed: ' + error.message, 'error');
      }
    }

    // Test Notification Permission
    async function testNotificationPermission() {
      try {
        log('üìù Current permission: ' + Notification.permission);
        
        if (Notification.permission === 'granted') {
          log('‚úÖ Permission already granted', 'success');
          return;
        }
        
        log('üìù Requesting permission...');
        const permission = await Notification.requestPermission();
        log('üìù Permission result: ' + permission);
        
        if (permission === 'granted') {
          log('‚úÖ Permission granted!', 'success');
        } else if (permission === 'denied') {
          log('‚ùå Permission denied', 'error');
        } else {
          log('‚ö†Ô∏è Permission dismissed');
        }
      } catch (error) {
        log('‚ùå Permission request failed: ' + error.message, 'error');
      }
    }

    // Test Subscribe
    async function testSubscribe() {
      try {
        if (!swRegistration) {
          log('‚ö†Ô∏è Please run Test 1 first (Service Worker)');
          return;
        }
        
        if (!vapidPublicKey) {
          log('‚ö†Ô∏è Please run Test 2 first (VAPID Key)');
          return;
        }
        
        if (Notification.permission !== 'granted') {
          log('‚ö†Ô∏è Please run Test 3 first (Permission)');
          return;
        }
        
        log('üìù Checking existing subscription...');
        let subscription = await swRegistration.pushManager.getSubscription();
        
        if (subscription) {
          log('‚úÖ Already subscribed: ' + subscription.endpoint, 'success');
          return;
        }
        
        log('üìù Creating new subscription...');
        const applicationServerKey = urlBase64ToUint8Array(vapidPublicKey);
        
        subscription = await swRegistration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: applicationServerKey
        });
        
        log('‚úÖ Subscription created!', 'success');
        log('Endpoint: ' + subscription.endpoint);
        
        // Send to server
        log('üìù Sending to server...');
        const response = await fetch(`${API_BASE_URL}/subscribe`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            subscription: subscription.toJSON(),
            userId: 'test_user_' + Date.now()
          })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        log('‚úÖ Subscription saved! ID: ' + data.subscriptionId, 'success');
        
      } catch (error) {
        log('‚ùå Subscribe failed: ' + error.message, 'error');
        log('Error details: ' + JSON.stringify(error, null, 2), 'error');
      }
    }

    // Test Send Notification
    async function testSendNotification() {
      try {
        log('üìù Sending test notification...');
        
        const response = await fetch(`${API_BASE_URL}/send-notification`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: 'Test t·ª´ Debug Page',
            body: 'Notification ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng! üéâ',
            url: '/'
          })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        log('‚úÖ Notification sent! Count: ' + (data.sentCount || 'N/A'), 'success');
        
      } catch (error) {
        log('‚ùå Send notification failed: ' + error.message, 'error');
      }
    }

    // Helper: Convert VAPID key
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding)
        .replace(/\-/g, '+')
        .replace(/_/g, '/');
      
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    // Initialize
    showBrowserInfo();
    log('üöÄ Debug page loaded. Click buttons to test each step.');
  </script>
</body>
</html>
